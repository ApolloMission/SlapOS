#!%(python_path)s

import httplib
import urllib
import base64

user = "%(user)s"
password = "%(password)s"
host = "%(host)s"
site_id = "%(site_id)s"
mysql_url = "%(sql_connection_string)s"
protocol = "%(protocol)s"
scalability = True

erp5_catalog_storage = 'erp5_mysql_innodb_catalog'

header_dict = {'Authorization': 'Basic %%s' %% \
  base64.encodestring('%%s:%%s' %% (user, password)).strip()}

if protocol == 'https':
  zope_connection = httplib.HTTPSConnection(host)
elif protocol == 'http':
  zope_connection = httplib.HTTPConnection(host)  
else:
  raise ValueError("Protocol not implemented")
  
# Check if an ERP5 site is already created, as ERP5 does support having
# 2 instances in the same zope, and this script should not destroy user data
zope_connection.request('GET', '/isERP5SitePresent', headers=header_dict)
result = zope_connection.getresponse()

if result.status == 204: # and (result.read() == "False"):

  # Use a new connection
  if protocol == 'https':
    zope_connection = httplib.HTTPSConnection(host)
  elif protocol == 'http':
    zope_connection = httplib.HTTPConnection(host)  
  else:
    raise ValueError("Protocol pot implemented") 

  # Create the expected ERP5 instance
  zope_connection.request(
    'POST', '/manage_addProduct/ERP5/manage_addERP5Site',
    urllib.urlencode({
      'id': site_id,
      'erp5_catalog_storage': erp5_catalog_storage,
      'erp5_sql_connection_string': mysql_url,
      'cmf_activity_sql_connection_string': mysql_url,
    }),
    headers=header_dict)
  # Wait for the erp5 response, to prevent multiple requests
  # been done by the same script.
  result = zope_connection.getresponse()

  # Read result make sure the site really finished to 
  #created the ERP5 site.
  result.read()
  print "ERP5 site created."


# Scalability: Install and configure small buisiness
if scalability:
  print "Scalability case"
  # Here check if configurator is available
  configurator_available = False
  cancel_url = "https%3A%2F%2F192.168.241.110%3A2153%2Ferp5%2FERP5Site_viewCheckConsistency"
  if not configurator_available:
    if is_scalability_case:
      import os
      # Fix site consistency
      if protocol == 'https':
        zope_connection = httplib.HTTPSConnection(host)
      elif protocol == 'http':
        zope_connection = httplib.HTTPConnection(host)  
      else:
        raise ValueError("Protocol not implemented")
      zope_connection.request(
        'POST', '/ERP5Site_updateConfigurationConsistency',
        urllib.urlencode({
          'update_method': 'ERP5Site_updateConfigurationConsistency',
          'dialog_id'='ERP5Site_viewCheckConsistency',
          'cancel_url'=cancel_url,
          'dialog_method'='ERP5Site_fixConfigurationConsistency',
          'dialog_category'='None',
          'object_path'='%2Ferp5',
          'form_id'='view',
          'select_favorite'='',
          'select_module'='',
          'select_language'='en',
          'all_languages'='1',
          'field_your_search_text'='Search',
          'default_field_your_enable_alarm%3Aint'='0',
          'field_your_enable_alarm'='on',
          'list_selection_name'='erp5_site_check_consistency_selection',
          'listbox_list_selection_name'='erp5_site_check_consistency_selection',
          'md5_object_uid_list'='d751713988987e9331980363e24189ce',
          'listbox_title'='',
          'uids%3Alist'='598',
          'listbox_uid%3Alist'='598',
          'listbox_uid%3Alist'='595',
          'listbox_uid%3Alist'='599',
          'Base_callDialogMethod%3Amethod'='',
        }),
        headers=header_dict)
      
      print "POST sent"
      result = zope_connection.getresponse()
      print result.read()
      print "POST read"
      

  # Here check if configurator is available
  configurator_available = False
  # Here check if S&MB not already installed
  configurator_already_applied = False
  if configurator_available and not configurator_already_applied:
    # install small and medium business via configurator
    pass

   
