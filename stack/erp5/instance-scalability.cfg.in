{% if slap_software_type == software_type -%}
[buildout]
parts =
  erp5-cluster
  launcher
  binary-wrap-launcher
  
eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true

# Request erp5-cluster instance
[erp5-cluster]
recipe = slapos.cookbook:request.serialised
sla = computer_guid
server-url = ${slap-connection:server-url}
key-file = ${slap-connection:key-file}
cert-file = ${slap-connection:cert-file}
computer-id = ${slap-connection:computer-id}
partition-id = ${slap-connection:partition-id}
name = ERP5 Cluster
software-url = ${slap-connection:software-release-url}
software-type = cluster
sla-computer_guid = {{ slapparameter_dict.get('launcher-computer-guid', computer_id) }}
config =
  use-ipv6
  ${:extra-config}
extra-config =
config-use-ipv6 = {{ dumps(slapparameter_dict.get('use-ipv6', False)) }}


# Create binary
[launcher]
scripts =
  runScalabilityTestSuite = erp5.util.scalability.runScalabilityTestSuite:main
log-path = ${basedirectory:log}/runScalabilityTestSuite.log
binary-path = ${:bin-directory}/runScalabilityTestSuite

# TODO : make also a wrapper for performance_tester (used by runScalabilityTestSuite)


# Create wrapper and execute command with parameters
[binary-wrap-launcher]
recipe = slapos.cookbook:wrapper
wrapper-path = ${rootdirectory:bin}/runScalabilityTestSuite
output = ${launcher:binary-path}
# TODO : get the erp5-cluster main url (apache listening user port ?)
erp5-url = http://foo.bar
# Run scalability test suite wrapper command with parameters
command-line = "${binary-wrap-launcher:wrapper-path}\
 --erp5-url ${binary-wrap-launcher:erp5-url}\
 --test-result-path {{ dumps(slapparameter_dict.get('test-result-path')) }}\
 --revision {{ dumps(slapparameter_dict.get('revision')) }}\
 --node-title {{ dumps(slapparameter_dict.get('node-title')) }}\
 --test-suite-master-url {{ dumps(slapparameter_dict.get('test-suite-master-url')) }}\
 --log-path = ${launcher:log-path}"
return = url


# Create partition's directories
[basedirectory]
recipe = slapos.cookbook:mkdirectory
log = ${rootdirectory:var}/log

[rootdirectory]
recipe = slapos.cookbook:mkdirectory
etc = ${buildout:directory}/etc
var = ${buildout:directory}/var
bin = ${buildout:directory}/bin

{% endif %}
