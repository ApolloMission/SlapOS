#!/usr/bin/python

import json
import os
import subprocess
import sys
import time

promise_dir = "{{ directory['promise'] }}"
service_dir = "{{ directory['service'] }}"
monitor_dir = "{{ directory['monitor'] }}"
instance_path = "{{ directory['home'] }}"

monitoring_file_json = "{{ monitoring_file_json }}"
monitoring_file_bool = "{{ monitoring_file_bool }}"


def getListOfScripts():
  scripts = []
  for dir in (promise_dir, monitor_dir):
    if os.path.exists(dir) and os.path.isdir(dir):
      for file in os.listdir(dir):
        scripts.append(os.path.join(dir, file))
  if scripts:
    return scripts
  else:
    exit("There is a problem in your directories" \
          "of monitoring. Please check them")


def run():
  scripts = getListOfScripts()
  script_timeout = 3
  result = {}
  for script in scripts:
    command = [os.path.join(promise_dir, script)]
    script = os.path.basename(command[0])
    result[script] = ''
    
    process_handler = subprocess.Popen(command,
                                       cwd=instance_path,
                                       env=None if sys.platform == 'cygwin' else {},
                                       stdout=subprocess.PIPE,
                                       stderr=subprocess.PIPE,
                                       stdin=subprocess.PIPE)
    process_handler.stdin.flush()
    process_handler.stdin.close()
    process_handler.stdin = None

    time.sleep(script_timeout)

    if process_handler.poll() is None:
      process_handler.terminate()
      result[script] = "Time Out"
    elif process_handler.poll() != 0:
      stderr = process_handler.communicate()[1]
      if stderr is not None:
        result[script] = stderr.strip()
  return result


if __name__ == "__main__":
  monitors = run()
  open(monitoring_file_json, "w+").write(json.dumps(fails))
  if len(monitors) == 0:
    open(monitoring_file_bool, "w+").write("SUCCESS : everything is ok")
    exit(0)
  else:
    open(monitoring_file_bool, "w+").write("FAILURE : something went wrong")
    exit(1)