#!{{ python_executable }}

import os
import cgi
import cgitb
import ConfigParser
import Cookie

cgitb.enable(display=0, logdir="/tmp/cgi.log")

form = cgi.FieldStorage()                                                                                
cookie = Cookie.SimpleCookie()                                                                           

print "Content-Type: text/html"

if "password" in form:                                                                                   
  password = form['password'].value                                                                      
  if password == '{{ password }}' :                                                                     
    cookie['password'] = password                                                                        
    print cookie
else:                                                                                                    
  cookie_string = os.environ.get('HTTP_COOKIE')                                                          
  if cookie_string:
    cookie.load(cookie_string)                                                                           
    try:
      password = cookie['password'].value                                                                
    except KeyError: 
      password = None                                                                                    
  else: 
    password = None                                                                                      

print 

if not password or password != '{{ password }}':
  print "<html><body>"
  if password is None:
    print "<h1>This is the monitoring interface</h1>"
  else:
    print "<h1>Error</h1><p>Wrong password</p>"
  print """
  <p>Please enter the monitor_password in the next field to access the data</p>                          
  <form action="/settings.cgi" method="post">                                                            
    Password : <input type="password" name="password">                                                   
    <input type="submit" value="Access">                                                                 
  </form></body></html>"""
  
else:
  config_file = "{{ config_cfg }}"
  if not os.path.exists(config_file):
    print "Your software does <b>not</b> embed 0-knowledge. \
    This interface is useless in this case"
    exit(0)
  parser = ConfigParser.ConfigParser()
  parser.read(config_file)
  if len(form) > 1:
    for name in form:
      if name != 'password':
        parser.set('public', name, form[name].value)
    with open("{{ config_cfg }}", 'w') as file:
      parser.write(file)
  print "<html><body>"
  print "<h1>Values that can be defined by the user :</h1>"
  print "<form action=\"/{{ this_filename }}\" method=\"post\">"
  print "<input type=\"hidden\" name=\"password\" value=\"{{ password }}\">"
  for option in parser.options("public"):
    print "%s : <input type=\"text\" name=\"%s\" \
    value=\"%s\"><br>"% (option, option, parser.get('public', option))
  print "<input type=\"submit\" value=\"Save\"></form>"
  
  print "<h1>Other values :</h1>"
  for section in parser.sections():
    if section != 'public':
      for option in parser.options(section):
        print "<b>%s</b> : value=\"%s\"<br>" % (option,
        parser.get(section, option))
  
  print "</body></html>"
