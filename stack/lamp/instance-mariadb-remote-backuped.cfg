[buildout]
extends =
    ${template-mariadb:output}

parts =
  url
  mariadb
  duplicity
  stunnel
  certificate-authority
  ca-stunnel
  logrotate
  logrotate-entry-mariadb
  logrotate-entry-stunnel
  cron
  cron-entry-logrotate
  cron-entry-mariadb-backup
  cron-entry-duplicity

[mydumper]
recipe = slapos.cookbook:mydumper
wrapper = $${rootdirectory:bin}/raw_mydumper
backup-directory = $${directory:mariadb-backup}
socket = $${mariadb:socket}
user = root
mydumper-binary = ${mydumper:location}/bin/mydumper
database = $${mariadb:database}
import = false

[mydumper-locked]
recipe = slapos.cookbook:lockfile
lock-file = $${basedirectory:run}/mysql-backup.lock
binary = $${mydumper:wrapper}
wrapper = $${rootdirectory:bin}/mydumper

[duplicity]
recipe = slapos.cookbook:duplicity
remote-backup = $${slap-parameter:backup-url}
local-directory = $${mydumper:backup-directory}
duplicity-binary = ${buildout:bin-directory}/duplicity
wrapper = $${rootdirectory:bin}/raw_duplicity
recover = false
cache = $${directory:duplicity-cache}

[duplicity-locked]
recipe = slapos.cookbook:lockfile
lock-file = $${mydumper-locked:lock-file}
binary = $${duplicity:wrapper}
wrapper = $${rootdirectory:bin}/duplicity
wait = true

[cron-entry-duplicity]
<= cron
recipe = slapos.cookbook:cron.d
name = remote_backup
frequency = 30 * * * *
command = $${duplicity-locked:wrapper}

[cron-entry-mariadb-backup]
<= cron
recipe = slapos.cookbook:cron.d
name = backup
frequency = 0 * * * *
command = $${mydumper-locked:wrapper}

[basedirectory]
cache = $${rootdirectory:var}/cache/

[directory]
mariadb-backup = $${basedirectory:backup}/mariadb/
duplicity-cache = $${basedirectory:cache}/duplicity/
