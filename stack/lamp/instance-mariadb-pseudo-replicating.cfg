[buildout]
parts =
  url
  mariadb
  duplicity-recover
  mydumper-import
  stunnel
  certificate-authority
  ca-stunnel
  logrotate
  logrotate-entry-mariadb
  logrotate-entry-stunnel
  cron
  cron-entry-logrotate
  cron-entry-duplicity-recover
  cron-entry-mariadb-import

extends = ${template-mariadb:output}

[duplicity-recover]
recipe = slapos.cookbook:duplicity
remote-backup = $${slap-parameter:backup-url}
local-directory = $${directory:duplicity-recover}
duplicity-binary = ${buildout:bin-directory}/duplicity
wrapper = $${rootdirectory:bin}/raw_duplicity
cache = $${directory:duplicity-cache}
recover = true

[duplicity-recover-locked]
recipe = slapos.cookbook:lockfile
lock-file = $${mydumper-import-locked:lock-file}
wrapper = $${rootdirectory:bin}/duplicity
binary = $${duplicity-recover:wrapper}
wait = true

[mydumper-import]
recipe = slapos.cookbook:mydumper
wrapper = $${rootdirectory:bin}/raw_myloader
backup-directory = $${directory:duplicity-recover}
socket = $${mariadb:socket}
user = root
myloader-binary = ${mydumper:location}/bin/myloader
database = $${mariadb:database}
import = true

[mydumper-import-locked]
recipe = slapos.cookbook:lockfile
lock-file = $${basedirectory:run}/import.lock
wrapper = $${rootdirectory:bin}/myloader
binary = $${mydumper-import:wrapper}
wait = true

[cron-entry-duplicity-recover]
<= cron
recipe = slapos.cookbook:cron.d
name = duplicity_recover
frequency = 30 * * * *
command = $${duplicity-recover-locked:wrapper}

[cron-entry-mariadb-import]
<= cron
recipe = slapos.cookbook:cron.d
name = mariadb_import
frequency = 0 * * * *
command = $${mydumper-import-locked:wrapper}

[basedirectory]
cache = $${rootdirectory:var}/cache/

[directory]
duplicity-recover = $${rootdirectory:srv}/recovering
duplicity-cache = $${basedirectory:cache}/duplicity
