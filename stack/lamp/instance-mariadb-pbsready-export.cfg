[buildout]
extends = ${template-mariadb-pbsready:output}

parts +=
  cron-entry-mariadb-backup
  notifier-mydumper
  mydumper

[mydumper]
recipe = slapos.cookbook:mydumper
wrapper = $${rootdirectory:bin}/mydumper_raw
backup-directory = $${directory:mariadb-backup}
socket = $${mariadb:socket}
user = root
mydumper-binary = ${mydumper:location}/bin/mydumper
database = $${mariadb:database}
import = false
compression = true

[notifier-mydumper-data]
write-url = $${urls:agent-url}log/mydumper

[notifier-mydumper]
<= notifier-mydumper-data
recipe = slapos.cookbook:agent.notifier
wrapper = $${rootdirectory:bin}/mydumper
command-line = $${mydumper:wrapper}
notifier-binary = ${buildout:bin-directory}/wp-agent-notifier
title = Dumping MariaDB
notify-url =
  $${request-pull-backup-server:connection-notify-url}

[cron-entry-mariadb-backup]
<= cron
recipe = slapos.cookbook:cron.d
name = backup
frequency = 0 * * * *
command = $${notifier-mydumper:wrapper}

[request-pull-backup-server]
name = Pull Backup Server pulling from main MariaDB
config-type = pull
config += trigger-feed
config-trigger-feed = $${notifier-mydumper-data:write-url}
