[buildout]

extends = ${template-mariadb-pbsready:output}

parts = 
  urls
  mariadb
  stunnel
  certificate-authority
  ca-stunnel
  logrotate
  logrotate-entry-mariadb
  logrotate-entry-stunnel
  logrotate-entry-cron
  cron
  cron-entry-logrotate
  sshkeys-authority
  dropbear-server
  sshkeys-dropbear
  dropbear-server-pbs-authorized-key
  cron-entry-mariadb-import

[mydumper-import]
recipe = slapos.cookbook:mydumper
wrapper = $${rootdirectory:bin}/raw_myloader
backup-directory = $${directory:mariadb-backup}
socket = $${mariadb:socket}
user = root
myloader-binary = ${mydumper:location}/bin/myloader
database = $${mariadb:database}
import = true

[mydumper-import-locked]
recipe = slapos.cookbook:lockfile
lock-file = $${basedirectory:run}/import.lock
wrapper = $${rootdirectory:bin}/myloader
binary = $${mydumper-import:wrapper}
wait = true

[cron-entry-mariadb-import]
<= cron
recipe = slapos.cookbook:cron.d
name = mariadb_import
frequency = 0 * * * *
command = $${mydumper-import-locked:wrapper}
