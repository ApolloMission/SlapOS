[buildout]
extends = ${template-mariadb-pbsready:output}

parts += 
    trigger-mydumper-import
    mydumper-import

[trigger-mydumper-import]
<= agent
recipe = slapos.cookbook:agent.trigger
on-feed = $${request-pull-backup-server:connection-feed-url}
executable = $${mydumper-import:wrapper}

[mydumper-import]
recipe = slapos.cookbook:mydumper
wrapper = $${rootdirectory:bin}/myloader
backup-directory = $${directory:mariadb-backup}
socket = $${mariadb:socket}
user = root
myloader-binary = ${mydumper:location}/bin/myloader
database = $${mariadb:database}
import = true

[request-pull-backup-server]
name = Pull Backup Server pushing on backup MariaDB
config-type = push
config += notify
config-notify = $${urls:notify-url}
