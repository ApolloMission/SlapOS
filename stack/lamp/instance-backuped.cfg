[buildout]

extends =
  ${template-apache-php:output}

parts =
  request-mariadb
  request-mariadb-pseudo-replicating
  request-pull-backup-server
  request-pull-backup-server-mariadb
  request-pull-backup-server-mariadb-backup
  url
  apache-php
  stunnel
  certificate-authority
  ca-stunnel
  logrotate
  logrotate-entry-apache
  logrotate-entry-stunnel
  cron
  cron-entry-logrotate

[request-pull-backup-server]
<= slap-connection
recipe = slapos.cookbook:request
name = PBS (Pull Backup Server)
software-url = $${slap-connection:software-release-url}
software-type = pull-backup
return = ssh-key
slave = false

[request-mariadb]
software-type = mariadb-pbsready-export
config = authorized-key
config-authorized-key = $${request-pull-backup-server:connection-ssh-key}
return = url ssh-public-key ssh-url

[request-mariadb-pseudo-replicating]
<= slap-connection
recipe = slapos.cookbook:request
name = MariaDB (backup)
software-url = $${slap-connection:software-release-url}
software-type = mariadb-pbsready-import
return = url ssh-public-key ssh-url
config = authorized-key
config-authorized-key = $${request-pull-backup-server:connection-ssh-key}

[request-pull-backup-server-mariadb]
<= request-pull-backup-server
   slap-connection
name = PBS pulling from MariaDB (backuped)
config = url name type server-key frequency
config-url = $${request-mariadb:connection-ssh-url}
config-name = $${slap-connection:computer-id}-$${slap-connection:partition-id}-mariadb
config-type = pull
config-server-key = $${request-mariadb:connection-ssh-public-key}
config-frequency = 15 0 * * *
slave = true

[request-pull-backup-server-mariadb-backup]
<= request-pull-backup-server
   slap-connection
name = PBS pushing on MariaDB (ready to use backup)
config = url name type server-key frequency
config-url = $${request-mariadb-pseudo-replicating:connection-ssh-url}
config-name = $${slap-connection:computer-id}-$${slap-connection:partition-id}-mariadb
config-type = push
config-server-key = $${request-mariadb-pseudo-replicating:connection-ssh-public-key}
config-frequency = 45 0 * * *
slave = true
