[buildout]

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

parts =
    publish
    shellinabox
    certificate-authority
    ca-shellinabox
    make-binary-link

[rootdirectory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
tmp = $${buildout:directory}/tmp
srv = $${buildout:directory}/srv
bin = $${buildout:directory}/bin
zerovm = $${buildout:directory}/zerovmbin

[basedirectory]
recipe = slapos.cookbook:mkdirectory
services = $${rootdirectory:etc}/run
promises = $${rootdirectory:etc}/promise

[directory]
recipe = slapos.cookbook:mkdirectory
shellinabox = $${rootdirectory:srv}/shellinabox/
ca-dir = $${rootdirectory:srv}/ca/

[cadirectory]
recipe = slapos.cookbook:mkdirectory
requests = $${directory:ca-dir}/requests/
private = $${directory:ca-dir}/private/
certs = $${directory:ca-dir}/certs/
newcerts = $${directory:ca-dir}/newcerts/
crl = $${directory:ca-dir}/crl/

[pwgen]
recipe = slapos.cookbook:pwgen
file = $${buildout:directory}/.password
pwgen-binary = ${pwgen:location}/bin/pwgen

[shell-wrapper]
recipe = slapos.recipe.template
url = ${template-shell-launch:location}/${template-shell-launch:filename}
output = $${rootdirectory:bin}/sh_raw
mode = 0700

zerovm_location = ${zerovm:location}
nacl_location = ${nacl_sdk:location}/pepper_23/toolchain/linux_x86_glibc
zrt = ${zrt:compile-directory}
sample_dir = ${zrt:compile-directory}/samples
shell = ${busybox:location}/bin/sh

[make-binary-link]
recipe = slapos.cookbook:symbolic.link
target-directory = $${rootdirectory:zerovm}
link-binary = 
  /usr/bin/make
  /usr/bin/setarch
  ${zerovm:location}/zerovm

[shell]
recipe = slapos.cookbook:shell
wrapper = $${rootdirectory:bin}/sh
shell = $${shell-wrapper:output}
home = $${buildout:directory}
ps1 = "\\w> "
path =
    $${rootdirectory:zerovm}
    ${buildout:parts-directory}/ncval
    ${python2.7:location}/bin/
    ${busybox:location}/bin/
    ${busybox:location}/usr/bin/
    ${buildout:bin-directory}/
    ${busybox:location}/sbin/
    ${busybox:location}/usr/sbin/

[shellinabox]
recipe = slapos.cookbook:shellinabox
ipv6 = $${slap-network-information:global-ipv6}
port = 8080
shell = $${shell:wrapper}
wrapper = $${rootdirectory:bin}/shellinaboxd_raw
shellinabox-binary = ${shellinabox:location}/bin/shellinaboxd
password = $${pwgen:password}
directory = $${buildout:directory}/
login-shell = $${rootdirectory:bin}/login
certificate-directory = $${directory:shellinabox}
cert-file = $${directory:shellinabox}/public.crt
key-file = $${directory:shellinabox}/private.key

[certificate-authority]
recipe = slapos.cookbook:certificate_authority
openssl-binary = ${openssl:location}/bin/openssl
ca-dir = $${directory:ca-dir}
requests-directory = $${cadirectory:requests}
wrapper = $${basedirectory:services}/ca
ca-private = $${cadirectory:private}
ca-certs = $${cadirectory:certs}
ca-newcerts = $${cadirectory:newcerts}
ca-crl = $${cadirectory:crl}

[ca-shellinabox]
<= certificate-authority
recipe = slapos.cookbook:certificate_authority.request
executable = $${shellinabox:wrapper}
wrapper = $${basedirectory:services}/shellinaboxd
key-file = $${shellinabox:key-file}
cert-file = $${shellinabox:cert-file}


[publish]
recipe = slapos.cookbook:publish
url = https://[$${shellinabox:ipv6}]:$${shellinabox:port}/
password = $${pwgen:password}
