[buildout]
parts =
  slapos-instance

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[slapos-instance]
recipe = slapos.recipe.cmmi
# This url is useless
path = $${buildout:directory}
pre-configure =
  declare -r installer=/opt/publish/slapos-windows-all-in-one.exe
  declare -r targetdir=$(cygpath -w $${buildout:directory})
  declare -r logfile=$(cygpath -w $${buildout:directory}/slapos-windows-installer.log)
  echo "$installer /DIR=\"\$targetdir\" /LOG=\"\$logfile\" /VERYSILENT" > $${:configure-command}
  chmod +x $${:configure-command}
configure-command = $${buildout:directory}/bootloader.sh
pre-install =
  cp /certificate $${buildout:directory}/cygwin/certificate
  cp /key $${buildout:directory}/cygwin/key
  cp /test-computer.crt $${buildout:directory}/cygwin/computer.crt
  cp /test-computer.key $${buildout:directory}/cygwin/computer.key
  cp /etc/slapos/scripts/slapos-windows-wrapper.bat $${buildout:directory}/slapos-windows-wrapper.bat
make-binary = true
post-install =
  $${buildout:directory}/slapos-windows-wrapper.bat /etc/slapos/scripts/slapos-configure.sh \
      --password=slaptester \
      --client-certificate=/certificate \
      --client-key=/key \
      --computer-certificate=/computer.crt \
      --computer-key=/computer.key
