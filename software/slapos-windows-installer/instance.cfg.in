[buildout]
parts =
  slapos-instance

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[slapos-instance]
recipe = slapos.recipe.cmmi
# This url is useless
path = $${buildout:directory}
pre-configure =
  echo "#! /bin/bash" > $${:configure-command}
  echo "declare -r installer=${installer:location}/slapos-windows-all-in-one.exe" >> $${:configure-command}
  echo "declare -r targetdir=\$(cygpath -w $${buildout:directory})" >> $${:configure-command}
  echo "declare -r logfile=\$(cygpath -w $${buildout:directory}/slapos-windows-installer.log)" >> $${:configure-command}
  echo "\$installer /DIR=\"\$targetdir\" /LOG=\"\$logfile\" /VERYSILENT" >> $${:configure-command}
  chmod +x $${:configure-command}
configure-command = $${buildout:directory}/bootloader.sh
pre-install =
  declare -r cyghome="$(cygpath -m -a /)/.."
  cp $cyghome/setup.exe $${buildout:directory}
  cp $cyghome/certificate $${buildout:directory}/cygwin/certificate
  cp $cyghome/key $${buildout:directory}/cygwin/key
  cp $cyghome/test-computer.crt $${buildout:directory}/cygwin/computer.crt
  cp $cyghome/test-computer.key $${buildout:directory}/cygwin/computer.key
  cp ${installer:cygroot}/slapos-windows-wrapper.bat $${buildout:directory}/slapos-windows-wrapper.bat
make-binary = true
# The parameter "slaptester" is the password of slapos administrator
# passed to configure script
post-install =
  $${buildout:directory}/slapos-windows-wrapper.bat slapos-configure slaptester
