[buildout]

extends =
  ../../component/mysql-tritonn-5.0/buildout.cfg
  ../../component/gzip/buildout.cfg
  ../../component/maatkit/buildout.cfg
  ../erp5/software.cfg

parts +=
  sanef.repository
  mysql-tritonn-5.0
  bt5-repository
  maatkit

[eggs]
# Just so buildout executes [bef_erp5-recipe] before [eggs], as
# - [eggs] references [bef_erp5-recipe]
# - [instance-recipe] needs [bef_erp5-recipe] to be finished
# - we cannot rely on anything else being executed before [eggs]
bef_dummy =
  ${z2loganalyser:location}

# XXX: Workaround for hack;
# slapos.core is added, as even if it is defined as dependency in bef_erp5-recipe
# it is not being fetched, maybe because of using this crazy hack.
# Note: Possibly everything from setup.py shall be done in same way.
eggs +=
  slapos.core

extra-paths +=
  ${products-erp5:location}

[template]
url = ${:_profile_base_location_}/instance.cfg
md5sum = e22bbf531d2b5f121462267cbd8d2ef8

[instance-recipe]
egg = slapos.cookbook
module = bef_erp5

[sanef.repository]
<= erp5
branch = CR1094
repository = https://saneftestbot:kucahS5oav6jahch@git.erp5.org/repos/sanef.git
command = (${git:location}/bin/git clone --quiet -b ${:branch} ${:repository} ${:location}) || (rm -fr ${:location} && exit 1)

[bt5-repository]
recipe = plone.recipe.command
stop-on-error = true
command =
  ${buildout:executable} ${erp5:location}/product/ERP5/bin/genbt5list ${erp5:location}/product/ERP5/bootstrap ${erp5:location}/bt5 ${sanef.repository:location}/bt5
update-command = ${:command}

[products-erp5]
recipe = plone.recipe.command
stop-on-error = true
location = ${buildout:parts-directory}/${:_buildout_section_name_}
update-command = ${:command}
command =
  mkdir -p ${:location}/Products &&
  for product in ${erp5:location}/product/* ; do ln -fs $product ${:location}/Products ; done &&
  for product in ${sanef.repository:location}/product/* ; do ln -fs $product ${:location}/Products ; done &&
  echo "__import__('pkg_resources').declare_namespace(__name__)" > "${:location}/Products/__init__.py"
