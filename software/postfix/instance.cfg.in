[buildout]
parts =
  directories
  postfix-main-cf
  postfix-master-cf
  postfix-symlinks-bin
  postfix-symlinks-sbin
  postfix-symlinks-libexec
  service-postfix-master
  sh-postfix-environment

#  publish-connection-parameter

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true


[instance-parameter]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap_connection:computer_id}
partition = $${slap_connection:partition_id}
url = $${slap_connection:server_url}
key = $${slap_connection:key_file}
cert = $${slap_connection:cert_file}


[directories]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
etc_postfix = $${:etc}/postfix
script = $${:etc}/run
service = $${:etc}/service
promise = $${:etc}/promise
usr = $${buildout:directory}/usr
usr_bin = $${:usr}/bin
usr_sbin = $${:usr}/sbin
var = $${buildout:directory}/var
var_spool = $${:var}/spool
var_spool_postfix = $${:var_spool}/postfix
var_spool_postfix_active = $${:var_spool_postfix}/active
var_spool_postfix_bounce = $${:var_spool_postfix}/bounce
var_spool_postfix_corrupt = $${:var_spool_postfix}/corrupt
var_spool_postfix_defer = $${:var_spool_postfix}/defer
var_spool_postfix_deferred = $${:var_spool_postfix}/deferred
var_spool_postfix_flush = $${:var_spool_postfix}/flush
var_spool_postfix_hold = $${:var_spool_postfix}/hold
var_spool_postfix_incoming = $${:var_spool_postfix}/incoming
var_spool_postfix_maildrop = $${:var_spool_postfix}/maildrop
var_spool_postfix_pid = $${:var_spool_postfix}/pid
var_spool_postfix_private = $${:var_spool_postfix}/private
var_spool_postfix_public = $${:var_spool_postfix}/public
var_spool_postfix_saved = $${:var_spool_postfix}/saved
var_spool_postfix_trace = $${:var_spool_postfix}/trace
var_lib = $${:var}/lib
var_mail = $${:var}/mail
var_lib_postfix = $${:var_lib}/postfix


[postfix-main-cf]
recipe = slapos.recipe.template:jinja2
template = inline:
    # http://www.postfix.org/STANDARD_CONFIGURATION_README.html
    # http://www.postfix.org/postconf.5.html
    queue_directory = {{ queue_directory }}
    command_directory = {{ command_directory }}
    daemon_directory = {{ daemon_directory }}
    data_directory = {{ data_directory }}
    mail_owner = {{ mail_owner }}
    myhostname = {{ myhostname }}
    mydomain = {{ mydomain }}
    unknown_local_recipient_reject_code = 550
    alias_maps = {{ alias_maps }}
    alias_database = {{ alias_database }}
    mail_spool_directory = {{ mail_spool_directory }}
    debug_peer_level = 2
    sendmail_path =
    newaliases_path =
    mailq_path =
    setgid_group = {{ setgid_group }}
    html_directory =
    manpage_directory =
    sample_directory =
    readme_directory =
    inet_protocols = ipv4
rendered = $${buildout:directory}/etc/postfix/main.cf
extensions = jinja2.ext.do
context =
    raw queue_directory $${directories:var_spool_postfix}
    raw command_directory $${directories:usr_sbin}
    raw daemon_directory ${postfix:location}/usr/libexec/postfix
    raw data_directory $${directories:var_lib_postfix}
    raw mail_owner postfix
    raw alias_database hash:$${directories:etc}/aliases
    raw alias_maps hash:$${directories:etc}/aliases, nis:mail.aliases
    raw mail_spool_directory $${directories:var_mail}
    raw mydomain localdomain
    raw myhostname test.localdomain
    raw setgid_group slapuser12
mode = 0644


[postfix-master-cf]
recipe = slapos.recipe.template:jinja2
template = inline:
    # http://www.postfix.org/master.5.html
    # ==========================================================================
    # service type  private unpriv  chroot  wakeup  maxproc command + args
    #               (yes)   (yes)   (yes)   (never) (100)
    # ==========================================================================
    smtp      inet  n       -       n       -       -       smtpd
    submission inet n       -       n       -       -       smtpd
    pickup    unix  n       -       n       60      1       pickup
    cleanup   unix  n       -       n       -       0       cleanup
    qmgr      unix  n       -       n       300     1       qmgr
    tlsmgr    unix  -       -       n       1000?   1       tlsmgr
    rewrite   unix  -       -       n       -       -       trivial-rewrite
    bounce    unix  -       -       n       -       0       bounce
    defer     unix  -       -       n       -       0       bounce
    trace     unix  -       -       n       -       0       bounce
    verify    unix  -       -       n       -       1       verify
    flush     unix  n       -       n       1000?   0       flush
    proxymap  unix  -       -       n       -       -       proxymap
    proxywrite unix -       -       n       -       1       proxymap
    smtp      unix  -       -       n       -       -       smtp
    relay     unix  -       -       n       -       -       smtp
    showq     unix  n       -       n       -       -       showq
    error     unix  -       -       n       -       -       error
    retry     unix  -       -       n       -       -       error
    discard   unix  -       -       n       -       -       discard
    local     unix  -       n       n       -       -       local
    virtual   unix  -       n       n       -       -       virtual
    lmtp      unix  -       -       n       -       -       lmtp
    anvil     unix  -       -       n       -       1       anvil
    scache    unix  -       -       n       -       1       scache
rendered = $${buildout:directory}/etc/postfix/master.cf
extensions = jinja2.ext.do
mode = 0644




[postfix-environment]
MAIL_CONFIG=$${directories:etc_postfix}


[sh-postfix-environment]
recipe = slapos.recipe.template:jinja2
template = inline:
  export MAIL_CONFIG="{{ postfix_environment['MAIL_CONFIG'] }}"
rendered = $${buildout:directory}/postfix-environment.sh
context =
  section postfix_environment postfix-environment
mode = 755


[service-postfix-master]
recipe = slapos.cookbook:wrapper
command-line = ${postfix:location}/usr/libexec/postfix/master
wrapper-path = $${directories:service}/start-postfix-master
environment = MAIL_CONFIG=$${directories:etc_postfix}


[postfix-symlinks-bin]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:usr_bin}
link-binary =
    ${postfix:location}/usr/bin/mailq
    ${postfix:location}/usr/bin/newaliases


[postfix-symlinks-sbin]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:usr_sbin}
link-binary =
    ${postfix:location}/usr/sbin/postalias
    ${postfix:location}/usr/sbin/postcat
    ${postfix:location}/usr/sbin/postconf
    ${postfix:location}/usr/sbin/postdrop
    ${postfix:location}/usr/sbin/postfix
    ${postfix:location}/usr/sbin/postkick
    ${postfix:location}/usr/sbin/postlock
    ${postfix:location}/usr/sbin/postlog
    ${postfix:location}/usr/sbin/postmap
    ${postfix:location}/usr/sbin/postmulti
    ${postfix:location}/usr/sbin/postqueue
    ${postfix:location}/usr/sbin/postsuper
    ${postfix:location}/usr/sbin/sendmail


[postfix-symlinks-libexec]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:usr}
link-binary =
    ${postfix:location}/usr/libexec



#[publish-connection-parameter]
#recipe = slapos.cookbook:publish
#name = Hello $${instance-parameter:configuration.name}!
