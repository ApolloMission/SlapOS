[buildout]
parts =
  directories
  postfix-main-cf
  postfix-master-cf
  postfix-symlinks-bin
  postfix-symlinks-sbin
  postfix-symlinks-libexec
  service-postfix-master
  sh-postfix-environment

#  publish-connection-parameter

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true


[instance-parameter]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap_connection:computer_id}
partition = $${slap_connection:partition_id}
url = $${slap_connection:server_url}
key = $${slap_connection:key_file}
cert = $${slap_connection:cert_file}


[directories]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
etc_postfix = $${:etc}/postfix
script = $${:etc}/run
service = $${:etc}/service
promise = $${:etc}/promise
usr = $${buildout:directory}/usr
usr_bin = $${:usr}/bin
usr_sbin = $${:usr}/sbin
var = $${buildout:directory}/var
var_spool = $${:var}/spool
var_spool_postfix = $${:var_spool}/postfix
var_spool_postfix_active = $${:var_spool_postfix}/active
var_spool_postfix_bounce = $${:var_spool_postfix}/bounce
var_spool_postfix_corrupt = $${:var_spool_postfix}/corrupt
var_spool_postfix_defer = $${:var_spool_postfix}/defer
var_spool_postfix_deferred = $${:var_spool_postfix}/deferred
var_spool_postfix_flush = $${:var_spool_postfix}/flush
var_spool_postfix_hold = $${:var_spool_postfix}/hold
var_spool_postfix_incoming = $${:var_spool_postfix}/incoming
var_spool_postfix_maildrop = $${:var_spool_postfix}/maildrop
var_spool_postfix_pid = $${:var_spool_postfix}/pid
var_spool_postfix_private = $${:var_spool_postfix}/private
var_spool_postfix_public = $${:var_spool_postfix}/public
var_spool_postfix_saved = $${:var_spool_postfix}/saved
var_spool_postfix_trace = $${:var_spool_postfix}/trace
var_lib = $${:var}/lib
var_mail = $${:var}/mail
var_lib_postfix = $${:var_lib}/postfix


[postfix-main-cf]
recipe = slapos.recipe.template:jinja2
template = ${postfix-main-cf-template:location}/${postfix-main-cf-template:filename}
rendered = $${buildout:directory}/etc/postfix/main.cf
extensions = jinja2.ext.do
context =
    raw queue_directory $${directories:var_spool_postfix}
    raw command_directory $${directories:usr_sbin}
    raw daemon_directory ${postfix:location}/usr/libexec/postfix
    raw data_directory $${directories:var_lib_postfix}
    raw mail_owner postfix
    raw alias_database hash:$${directories:etc}/aliases
    raw alias_maps hash:$${directories:etc}/aliases, nis:mail.aliases
    raw mail_spool_directory $${directories:var_mail}
    raw mydomain localdomain
    raw myhostname test.localdomain
    raw setgid_group slapuser12
mode = 0644


[postfix-master-cf]
recipe = slapos.recipe.template:jinja2
template = ${postfix-master-cf-template:location}/${postfix-master-cf-template:filename}
rendered = $${buildout:directory}/etc/postfix/master.cf
extensions = jinja2.ext.do
#context =
mode = 0644


[postfix-environment]
MAIL_CONFIG=$${directories:etc_postfix}


[sh-postfix-environment]
recipe = slapos.recipe.template:jinja2
template = inline:
  export MAIL_CONFIG="{{ postfix_environment['MAIL_CONFIG'] }}"
rendered = $${buildout:directory}/postfix-environment.sh
context =
  section postfix_environment postfix-environment
mode = 755


[service-postfix-master]
recipe = slapos.cookbook:wrapper
command-line = ${postfix:location}/usr/libexec/postfix/master
wrapper-path = $${directories:service}/start-postfix-master
environment = MAIL_CONFIG=$${directories:etc_postfix}


[postfix-symlinks-bin]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:usr_bin}
link-binary =
    ${postfix:location}/usr/bin/mailq
    ${postfix:location}/usr/bin/newaliases


[postfix-symlinks-sbin]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:usr_sbin}
link-binary =
    ${postfix:location}/usr/sbin/postalias
    ${postfix:location}/usr/sbin/postcat
    ${postfix:location}/usr/sbin/postconf
    ${postfix:location}/usr/sbin/postdrop
    ${postfix:location}/usr/sbin/postfix
    ${postfix:location}/usr/sbin/postkick
    ${postfix:location}/usr/sbin/postlock
    ${postfix:location}/usr/sbin/postlog
    ${postfix:location}/usr/sbin/postmap
    ${postfix:location}/usr/sbin/postmulti
    ${postfix:location}/usr/sbin/postqueue
    ${postfix:location}/usr/sbin/postsuper
    ${postfix:location}/usr/sbin/sendmail


[postfix-symlinks-libexec]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:usr}
link-binary =
    ${postfix:location}/usr/libexec



#[publish-connection-parameter]
#recipe = slapos.cookbook:publish
#name = Hello $${instance-parameter:configuration.name}!
