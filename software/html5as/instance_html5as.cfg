[buildout]
parts =
    nginx_conf
    html5as_bin
    website_download
    publish-connection-information

offline = true

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}

# partition tree
# /
# |- etc/
# |    |- nginx.conf
# |    |- run/
# |         |- html5as (binary)
# |- var/
# |    |- run/
# |    |    |- nginx.pid
# |    |- log/
# |    |    |- nginx.log
# |    |    |- nginx.access.log
# |- srv/
# |    |- html5as/ (doc root)
# |    |        |- index.html
# |    |- backup/

[rootdirectory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
var = $${buildout:directory}/var
srv = $${buildout:directory}/srv

[basedirectory]
recipe = slapos.cookbook:mkdirectory
services = $${rootdirectory:etc}/run
log = $${rootdirectory:var}/log
run = $${rootdirectory:var}/run
backup = $${rootdirectory:srv}/backup
data = $${rootdirectory:srv}/html5as

[html5as]
# Options
nb_workers = 2

# Network
ip = $${slap-network-information:global-ipv6}
port = 8080

# Paths
# Log
path_pid = $${basedirectory:run}/nginx.pid
path_log = $${basedirectory:log}/nginx.log
path_access_log = $${basedirectory:log}/nginx.access.log
path_error_log = $${basedirectory:log}/nginx.error.log
path_tmp = $${buildout:directory}/tmp
# Docroot
docroot = $${basedirectory:data}
default_index = $${basedirectory:data}/index.html
# Config files
path_nginx_conf = $${rootdirectory:etc}/nginx.conf
# Executables
bin_nginx = ${nginx:location}/sbin/nginx
bin_html5as = $${basedirectory:services}/html5as

# Utils
path_shell = ${dash:location}/bin/dash

[website_download]
recipe = hexagonit.recipe.download
# Website tarball
url = $${slap-parameter:download_url}
destination = $${html5as:docroot}

[nginx_conf]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/templates/nginx_conf.in
rendered = $${html5as:path_nginx_conf}
md5sum = 6338abecda61f4414392b6f4c1d09e8a
context = section param_html5as html5as

[html5as_bin]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/templates/html5as_bin.in
rendered = $${html5as:bin_html5as}
md5sum = 0ddb3dfbd963819a1666ca47aa37bbc5
context = section param_html5as html5as
mode = 700

[publish-connection-information]
recipe = slapos.cookbook:publish
server_url = http://[$${html5as:ip}]:$${html5as:port}
