
This document explores backup and disaster recovery issues with Zimbra (Buildout Edition).

As we have not yet automated a backup solution, we show some of the alternatives
and the possible tradeoffs.


-----------------------------
Backup in the Network Edition
-----------------------------

The commercial version of ZCS ships with automatically configured "on the fly"
weekly (full) and daily (incremental) backup, of all user and server data.
There is no need to shut down any service while the backup is performed.

Although most backup related commands are not provided in the Open Source Edition,
they may be referenced in blogs, forums or wiki of the Zimbra project.

The following commands are not available in OSE/BE:

        zmbackup
        zmbackupabort
        zmbackupquery
        zmmailboxmove
        zmrestore
        zmrestoreldap
        zmrestoreoffline
        zmschedulebackup

Official documentiation is available at

http://www.zimbra.com/docs/ne/8.0.4/administration_guide/wwhelp/wwhimpl/js/html/wwhelp.htm#href=804_Network_Admin.Backup_and_Restore.html


To offer a similar experience for OSE users willing to pay, a company
named ZeXtras provides a commercial solution, see http://www.zextras.com




---------------------------------
Backup in the Open Source Edition
---------------------------------

Over the years, many backup scripts and packages have been created by the community.
They basically need to be tailored to each context, and use one of two approaches:
full snapshot of /opt/zimbra (for disaster recovery), or data export user-by-user
(for restoring data after human error - either by users or admins).

Most of the backup scripts we have examined use hardcoded pathnames for
/opt/zimbra and need to be run as 'root' or 'zimbra' user. Therefore, the code
must be adapted in order to work with the Buildout Edition.

A full backup would contain at least:

    - mail content: ./store (filesystem)
    - mail metadata/indexes: ./db/data (mysql)
    - user contacts, calendar: ./db/data (mysql)
    - ldap database: ./data/ldap
    - user passwords and settings: ldap
    - authentication certificate/keys: filesystem + ldap
    - mysql antispam: data/amavisd (mysql)
    - ./conf/localconfig.xml
    - other configuration settings (in subfolders and mysql)
    - server ip address (mysql)
    - logs (needed for forensic analysis)


A comprehensive list of the techniques is discussed in the Zimbra forum at

    http://www.zimbra.com/forums/administrators/15275-solved-yet-another-backup-script-community-version.html





Disaster Recovery: Open Source Edition
--------------------------------------

Most backup tools in this group follow the pattern:

    - live rsync of /opt/zimbra
    - zmcontrol stop
    - cold rsync of /opt/zimbra
    - zmcontrol restart
    - copy the backup offsite

The archived content of /opt/zimbra can later be restored on a similar server.
The new server must:

    - have the same Linux distribution, version and architecture
    - have the same hostname and FQDN in /etc/hosts
    - have a matching 'zimbra' user with the same User ID as the one in the old server
    - have blocked/firewalled outgoing SMTP ports to avoid mail duplicates
      (or empty message queues)

Some of the scripts use LVM snapshot instead of rsync.

The restore procedure relies on the fresh installation of .deb packages identical
to those installed in the old server, then replacing of the content in /opt/zimbra.
It is described by a blog post at

    http://blog.zimbra.com/blog/archives/2007/10/moving-zcs-to-another-server.html


Even in case of cold backup with no LDAP service running, Zimbra developers strongly
recommend a text dump of the LDAP database to avoid corruption, see
http://bugzilla.zimbra.com/show_bug.cgi?id=78781

Bacula is also a popular choice for off-site backup among Zimbra administrators.


* A note on LDAP and sparse files *

    With version 8.x, zimbra is preconfigured with a huge (86GB) memory-mapped sparse
    file for holding LDAP data. Additional care must be take into account when
    making a copy of this file, with rsync or other methods:

        http://www.zimbra.com/forums/administrators/59592-ldap-database-went-97meg-86gig.html
        http://wiki.zimbra.com/wiki/OpenLDAP_Performance_Tuning_8.0#Notes_on_MDB

    The file can either be separately copied with the mdb_copy utility, or dumped as
    a text file with zmslapcat. Using rsync with the --sparse option is not recommended.



List of backup scripts for disaster recovery:

    http://www.harkness.co.uk/tech_notes/Tech_Notes/Tech/Entries/2013/3/9_Zimbra_migration.html
    http://blog.zimbra.com/blog/archives/2007/10/moving-zcs-to-another-server.html
    http://sangacollins.wordpress.com/2013/04/21/zimbra-backup-script-with-ldap-export-for-zimbra-8/
    http://wiki.zimbra.com/wiki/Open_Source_Edition_Backup_Procedure
    http://wiki.zimbra.com/wiki/Backing_up_and_restoring_Zimbra_(Open_Source_Version)
    http://www.osoffice.de/howto/yet-another-backup-script-for-zimbra-community-edition-groupware-server.html
    https://github.com/tuanta/zimbra-lvm-backup





Disaster Recovery: Buildout Edition
-----------------------------------

As with the Open Source Edition, we start with a full backup of $ZIMBRA_HOME.
The recovery procedure is almost the same, except we don't need to install the .deb
packages because everything is provided by buildout.

The new server must:

    - have the same Linux distribution, version and architecture
    - have the same $ZIMBRA_HOME path
    - have the same hostname and FQDN in /etc/hosts
    - have a matching 'slapuser#' user with the same name and UID as the one in the old server
    - have blocked/firewalled outgoing SMTP ports to avoid mail duplicates
    - buildout parts have been executed for slapos components (no need to build and deploy zimbra parts)


If the hostname has changed, it should be updated as described in

    http://wiki.zimbra.com/index.php?title=ZmSetServerName

If only the IP has changed but the hostname is the same, no update is needed.




User backup: Open Source Edition
--------------------------------

This high-level method allows a partial extraction of the data, generally
including email, contacts and calendar, but no user passwords, application
settings, antispam training or LDAP database.

The purpose is to be able to retrieve a whole account or specific messages that
may have been deleted by the users themselves or the admins. Doing the same on
a snapshot of /opt/zimbra would require installing a parallel instance and
restoring everything there.

This type of backup is done with a running system, and cannot be incremental:
all of the account data is exported every time, possibly creating huge zip files.
Data is downloaded and uploaded through a REST interface, the operation can be
quite slow and cpu/memory intensive for some accounts.

The backup tools in this group follow the pattern:

        # backup
        for each user:
           zmmailbox -z -m user@domain.com getRestURL "//?fmt=zip" > /path/to/backup/user@domain.com.zip

        # restore
        for each user:
           zmmailbox -z -m user@domain.com postRestURL "//?fmt=zip&resolve=reset" /path/to/backup/user@domain.com.zip

Accounts to restore must be created in advance.
User settings and passwords are stored in LDAP and can be managed with the zmprov command.


Each user account can be put in "maintenance mode" while running the necessary operation.
In maintenance mode, login is disabled and incoming mail is queued by MTA:

    $ zmprov ma user@domain.com zimbraAccountStatus maintenance

If for some reason an account is left in maintenance mode by the zmmailbox command, it can be reactivated:

    $ zmprov ma user@domain.com zimbraAccountStatus active



List of backup scripts for user-by-user backup:

    https://github.com/bggo/Zmbkpose
    https://github.com/jasensio/BackupZimbraAccount
    https://github.com/wingyplus/zmbackup
    http://wiki.zimbra.com/wiki/HOT_Backup_with_rdiff-backup
    http://blog.zimbra.com/blog/archives/2008/09/zcs-to-zcs-migrations.html
    http://wiki.zimbra.com/wiki/Per_User_Mailbox_Backup_(OE_Version)
    (obsolete, but explains metadata in mysql)




User backup: Buildout Edition
-----------------------------

The same procedure applies in OSE and Buildout Edition.



Version upgrade: Open Source Edition
------------------------------------

When a new version of Zimbra is released, it can be installed with:

    - stop services, backup /opt/zimbra
    - unpack the new version's .tar.gz
    - install.sh (which will run necessary data migration, configuration
      and schema changes)

Moving to another server and upgrading Zimbra version can NOT be done at
the same time. The application must be migrated to the new server,
then the new version can be installed.



Version upgrade: Buildout Edition
---------------------------------

At the moment we don't have two version of zimbra that compile with buildout, therefore
we cannot test any version migration procedure.

As current proposal, when a new version of Zimbra will be released:

    - take a snapshot of its Perforce branch to git
    - rebase our commits in https://git.erp5.org/gitweb/zimbra.git/shortlog/refs/heads/authbind
      to the new version
    - examine any new or changed maintenance script, if needed adapt them
      by applying the techniques described in README.txt
    - IMPORTANT: adapt the related migration steps in ZimbraBuild/rpmconf/Upgrade/zmupgrade.pm,
      push the changes to a new branch
    - test the migration on a pair of dedicated Zimbra instances (old and new version,
      with test data)
    - build the new branch on a separate machine with matching distribution, version,
      architecture, $ZIMBRA_HOME, hostname, FQDN, username/UID of the user that runs zimbra
      on the target server.
      DO NOT run this step on the target server, as it would remove all the data.
    - backup $ZIMBRA_HOME on the target server
    - deploy the new version in the taget server with

        $ bin/buildout install deploy-zimbra-{all,ldap,mta,store}

    - run libexec/zmsetup.pl


    NOTE:
        Security updates to the components provided by SlapOS itself should be applied by rebuilding
        these parts. Testing the safety of the procedure is not trivial.
        If any component is released with a new version and library names change, it might also be
        required to rebuild the full Zimbra part. This MUST be done in a separate server with matching
        parameters, and can then be deployed on the target server as described above.


