[buildout]

parts =
    extranet-symlinks
    extranet-service
    extranet-promise
    config-staging-py
    config-production-py
    csrf-secret-key


[extranet-symlinks]
recipe = slapos.cookbook:symbolic.link
target-directory = $${directories:bin}
link-binary =
    ${buildout:directory}/bin/abilian


[extranet-service]
recipe = slapos.recipe.template:jinja2
template = inline:
    #!/bin/bash
    . {{environment}}
    [ -f "$${json-extra-configuration:json-output}" ] || {
        echo "Configuration file $${json-extra-configuration:json-output} does not exist (yet?)" >&2
        exit 10
    }
    [ -f "$${buildout:directory}/partition-parameters.json" ] || {
        echo "Configuration file $${buildout:directory}/partition-parameters.json does not exist (yet?)" >&2
        exit 20
    }
    [ -f "$${config-staging-py:rendered}" ] || {
        echo "Configuration file $${config-staging-py:rendered} does not exist (yet?)" >&2
        exit 30
    }
    [ -f "$${config-production-py:rendered}" ] || {
        echo "Configuration file $${config-production-py:rendered} does not exist (yet?)" >&2
        exit 40
    }
    exec {{abilian}} run
rendered = $${directories:services}/abilian-start
mode = 700
context =
    raw     environment     $${buildout:directory}/environment.sh
    raw     abilian         ${buildout:directory}/bin/abilian


[extranet-promise]
recipe = slapos.cookbook:check_port_listening
path = $${directories:promises}/extranet
hostname = $${instance-parameters:ipv6-random}
port = 5000


[config-staging-py]
recipe = slapos.recipe.template:jinja2
template = ${config-staging-py-template:location}/${config-staging-py-template:filename}
rendered = $${buildout:directory}/etc/staging.py
mode = 600
#context =
#    section config config-staging


[config-production-py]
recipe = slapos.recipe.template:jinja2
template = ${config-production-py-template:location}/${config-production-py-template:filename}
rendered = $${buildout:directory}/etc/production.py
mode = 600



[csrf-secret-key]
recipe = slapos.cookbook:generate.password
#no need to write other than in the json parameter file
#storage-path = $${directories:etc}/csrf_secret_key
bytes = 50

