[buildout]

parts =
  sh-environment
  put-files
  mapper
  reducer
  run-demo
  start-daemons
  deploy-tar

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}


[sh-environment]
# environment needed for running/debugging the applications, exported to a shell script to be sourced.
recipe = collective.recipe.template
output = $${buildout:directory}/environment.sh
input = inline:
  export JAVA_HOME="${java:location}"
  export HADOOP_PREFIX="$${directories:hadoop-prefix}"
  export PATH="$PATH:$HADOOP_PREFIX/bin"
  export HADOOP_HOME="$HADOOP_PREFIX"
  export HADOOP_COMMON_HOME="$HADOOP_PREFIX"
  export HADOOP_CONF_DIR="$HADOOP_PREFIX/etc/"
  export HADOOP_HDFS_HOME="$HADOOP_PREFIX"
  export HADOOP_MAPRED_HOME="$HADOOP_PREFIX"
  export HADOOP_YARN_HOME="$HADOOP_PREFIX"


[deploy-tar]
recipe = plone.recipe.command
update = true
command =
    [ -d $${directories:hadoop-prefix}/bin} ] || tar xf ${hadoop:location}/${hadoop:filename} -C $${directories:hadoop-prefix}  --strip-components=1



[directories]
recipe = slapos.cookbook:mkdirectory
bin = $${buildout:directory}/bin
etc = $${buildout:directory}/etc
hadoop-prefix = $${buildout:directory}/hadoop
services = $${directories:etc}/service
promises = $${directories:etc}/promise


[put-files]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/template/bin/put-files.sh.in
output = $${directories:bin}/put-files.sh
# md5sum = 
mode = 0755


# http://www.michael-noll.com/tutorials/writing-an-hadoop-mapreduce-program-in-python/

[mapper]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/template/bin/gutenberg-mapper.py.in
output = $${directories:bin}/gutenberg-mapper.py
# md5sum =
mode = 0755


[reducer]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/template/bin/gutenberg-reducer.py.in
output = $${directories:bin}/gutenberg-reducer.py
# md5sum =
mode = 0755

[run-demo]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/template/bin/run-demo.sh.in
output = $${directories:bin}/run-demo.sh
# md5sum =
mode = 0755

[start-daemons]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/template/bin/start-daemons.sh.in
output = $${directories:bin}/start-daemons.sh
# md5sum =
mode = 0755

