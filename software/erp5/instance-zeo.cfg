#############################
#
# Instanciate zeo
#
# zeo-id -- local id of the requested zeo (1,2,3,...)
#
# zeo-port -- ip port to use to run the process
#
# storage_list -- string with list of all resquested storage
#    Example: event_module person_module
#
#############################
log-path = $${rootdirectory:log}/zeo-$${slap-parameter:zeo-id}.log
pid-path = $${rootdirectory:run}/zeo-$${slap-parameter:zeo-id}.pid
conf-path = $${rootdirectory:etc}/zeo-$${slap-parameter:zeo-id}.conf
zodb-path = $${basedirectory:zodb}
ip = $${slap-network-information:local-ipv4}
port = $${slap-parameter:zeo-port}
storage = $${slap-parameter:storage_list}
wrapper-path = $${basedirectory:services}/zeo-$${slap-parameter:zeo-id}

[buildout]
parts =
  zeo-instance

  logrotate
  logrotate-entry-zeo
  cron
  cron-entry-logrotate

  publish-zeo-connection-information

gzip-binary = ${gzip:location}/bin/gzip

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[rootdirectory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc/
var = $${buildout:directory}/var/
srv = $${buildout:directory}/srv/
bin = $${buildout:directory}/bin/

[basedirectory]
recipe = slapos.cookbook:mkdirectory
log = $${rootdirectory:var}/log/
services = $${rootdirectory:etc}/run/
run = $${rootdirectory:var}/run/
backup = $${rootdirectory:srv}/backup/
zodb = $${rootdirectory:srv}/zodb/

[directory]
recipe = slapos.cookbook:mkdirectory
cron-entries = $${rootdirectory:etc}/cron.d/
crontabs = $${rootdirectory:etc}/crontabs/
cronstamps = $${rootdirectory:etc}/cronstamps/
cronoutput = $${basedirectory:log}/cron/
logrotate-backup = $${basedirectory:backup}/logrotate/
logrotate-entries = $${rootdirectory:etc}/logrotate.d/

[zeo-instance]
recipe = slapos.cookbook:zeo
log-path = $${rootdirectory:log}/zeo-$${slap-parameter:zeo-id}.log
pid-path = $${rootdirectory:run}/zeo-$${slap-parameter:zeo-id}.pid
conf-path = $${rootdirectory:etc}/zeo-$${slap-parameter:zeo-id}.conf
zodb-path = $${basedirectory:zodb}
ip = $${slap-network-information:local-ipv4}
port = $${slap-parameter:zeo-port}
storage = $${slap-parameter:storage_list}
wrapper-path = $${basedirectory:services}/zeo-$${slap-parameter:zeo-id}
binary-path = ${buildout:bin-directory}/runzeo

[publish-memcached-connection-information]
recipe = slapos.cookbook:publishurl
url = zeo://$${zeo-instance:ip}:$${zeo-instance:port}/

[cron]
recipe = slapos.cookbook:cron
dcrond-binary = ${dcron:location}/sbin/crond
cron-entries = $${directory:cron-entries}
crontabs = $${directory:crontabs}
cronstamps = $${directory:cronstamps}
catcher = $${cron-simplelogger:binary}
binary = $${basedirectory:services}/crond

[cron-simplelogger]
recipe = slapos.cookbook:simplelogger
binary = $${rootdirectory:bin}/cron_simplelogger
output = $${directory:cronoutput}

[cron-entry-logrotate]
<= cron
recipe = slapos.cookbook:cron.d
name = logrotate
frequency = 0 0 * * *
command = $${logrotate:wrapper}

[logrotate-entry-zeo]
<= logrotate
recipe = slapos.cookbook:logrotate.d
name = zeo-$${slap-parameter:zeo-id}
log = $${zeo-instance:log-path}
frequency = daily
rotate-num = 3650
sharedscripts = true
notifempty = true
create = true
post = $${killpidfromfile:binary} $${zeo-instance:pid-path} SIGUSR2

[killpidfromfile]
binary = $${notimplemented:getkillpidfromfilefromsoftware}

# rest of parts are candidates for some generic stuff

[logrotate]
recipe = slapos.cookbook:logrotate
# Binaries
logrotate-binary = ${logrotate:location}/usr/sbin/logrotate
gzip-binary = $${buildout:gzip-binary}
gunzip-binary = ${gzip:location}/bin/gunzip
# Directories
wrapper = $${rootdirectory:bin}/logrotate
conf = $${rootdirectory:etc}/logrotate.conf
logrotate-entries = $${directory:logrotate-entries}
backup = $${directory:logrotate-backup}
state-file = $${rootdirectory:srv}/logrotate.status
