[buildout]
parts = apache-php

extends =
  ../apache/buildout.cfg
  ../bison/buildout.cfg
  ../bzip2/buildout.cfg
  ../cclient/buildout.cfg
  ../curl/buildout.cfg
  ../freetype/buildout.cfg
  ../gettext/buildout.cfg
  ../libiconv/buildout.cfg
  ../libjpeg/buildout.cfg
  ../libpng/buildout.cfg
  ../libtool/buildout.cfg
  ../mariadb/buildout.cfg
  ../openldap/buildout.cfg
  ../pkgconfig/buildout.cfg
  ../zip/buildout.cfg

[apache-php]
# Note: Shall react on each build of apache and reinstall itself
recipe = slapos.recipe.cmmi
dependencies = bison mariadb apache libxml2 zlib bzip2 libmcrypt libjpeg libpng freetype curl zip gettext openssl libtool libiconv
url = http://fr2.php.net/distributions/php-5.3.13.tar.gz
md5sum = 179c67ce347680f468edbfc3c425476a
configure-options =
  --with-apxs2=${apache:prefix}/bin/apxs
  --with-libxml-dir=${libxml2:prefix}
  --with-mysql=${mariadb:prefix}
  --with-zlib-dir=${zlib:prefix}
  --with-mcrypt=${libmcrypt:prefix}
  --with-gd
  --with-jpeg-dir=${libjpeg:prefix}
  --with-png-dir=${libpng:prefix}
  --enable-gd-native-ttf
  --with-freetype-dir=${freetype:prefix}
  --with-pdo-mysql=mysqlnd
  --with-mysqli=mysqlnd
  --with-curl=${curl:prefix}  
  --with-gettext=${gettext:prefix}
  --with-openssl=${openssl:prefix}
  --enable-libxml
  --enable-mbstring
  --enable-session
  --enable-exif
  --enable-ftp

[x86-linux-apache-php]
dependencies = ${apache-php:dependencies} cclient openldap
configure-options =
  ${apache-php:configure-options}
  --with-imap=${cclient:prefix}
  --with-ldap=${openldap:prefix}
  --with-imap-ssl
  --with-zip-dir=${zip:prefix}
  --enable-zip
  --with-bz2-dir=${bzip2:prefix}
  --enable-bz2
  --with-ttf
  --with-iconv-dir=${libiconv:prefix}

[x86-cygwin-apache-php]
pre-configure = 
  rm -f build/libtool.m4
  ac_macrodir=build libtoolize --copy --force || error "libtoolize failed"
  cat build/lt*.m4 >> build/libtool.m4
  make -j1 -B -f build/build.mk ZENDDIR="Zend"
  true
pre-build =
  _X_=$(grep 'CFLAGS_CLEAN =' Makefile); _X_=$${_X_:15}; _X_=$${_X_//\//\\/}
  sed -i -e "s/^LTCFLAGS=.*$/LTCFLAGS=\" $_X_ \"/g" -e "s/\/cyg\//\/lib\//g" libtool
configure-options =
  ${apache-php:configure-options}
  --enable-zip=${zip:prefix}
  --with-bz2=${bzip2:prefix}
  --without-iconv

patch-options = -p2
patches = ${:_profile_base_location_}/cygwin-php-5.3.13.patch

[libmcrypt]
recipe = slapos.recipe.cmmi
url = http://sourceforge.net/projects/mcrypt/files/Libmcrypt/2.5.8/libmcrypt-2.5.8.tar.bz2/download
md5sum = c4f491dd411a09e9de3b8702ea6f73eb

[xml-rpc]
recipe = slapos.recipe.cmmi
url = http://downloads.sourceforge.net/project/phpxmlrpc/phpxmlrpc/2.2.2/xmlrpc-2.2.2.tar.gz
md5sum = 59a644c636c6d98267d0c99b406ae9e8

[no-environment]
environment =
  PKG_CONFIG_PATH=${libxml2:location}/lib/pkgconfig:${openssl:location}/lib/pkgconfig
  PATH=${pkgconfig:location}/bin:${bzip2:location}/bin:${libxml2:location}/bin:%(PATH)s
  LDFLAGS =-L${bzip2:location}/lib -Wl,-rpath -Wl,${bzip2:location}/lib -L${libtool:location}/lib -Wl,-rpath -Wl,${libtool:location}/lib -L${zlib:location}/lib -Wl,-rpath -Wl,${zlib:location}/lib -L${libmcrypt:location}/lib -Wl,-rpath -Wl,${libmcrypt:location}/libblkid

configure-options = 
  --with-bz2-dir=${bzip2:prefix}
  --with-zip-dir=${zip:prefix}
  --enable-bz2
