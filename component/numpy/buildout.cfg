[buildout]

extends =
  ../git/buildout.cfg
  ../gcc/buildout.cfg
  ../libatlas/buildout.cfg
  ../libblas/buildout.cfg


[scipy-repository.git]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/scipy/scipy.git
branch = maintenance/0.13.x
git-executable = ${git:location}/bin/git

[scikit-learn-repository.git]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/scikit-learn/scikit-learn.git
branch = 0.15.X
git-executable = ${git:location}/bin/git


[numpy-build-venv]
dependency = ${numpy-prerequired-egg:recipe}
recipe = cp.recipe.cmd
location = ${buildout:parts-directory}/${:_buildout_section_name_}
install_cmd =
  if [ -d ${:location} ]; then
    exit
  fi
  mkdir -p ${:location}
  cd ${:location}
  unset PYTHONPATH
  # need to find our gcc, and cython
  export PATH="${gcc-fortran:location}/bin:${buildout:directory}/bin:$PATH"
  export LD_PRELOAD="${gcc-fortran:location}/lib64/libgfortran.so.3 ${libblas:location}/libf77blas.so.3"
  export ATLAS=${libatlas:location}/lib/libsatlas.so
  export BLAS=${libblas:location}/libfblas.a
  export LAPACK=${libatlas:location}/lib/liblapack.a
  export NUMPY_EGG=${buildout:eggs-directory}/numpy-${versions:numpy}-py2.7-linux-x86_64.egg
  ${buildout:directory}/bin/virtualenv ${:location}
  . ${:location}/bin/activate
  # we need to install numpy to satisfy the dependency...
  # ${:location}/bin/pip install numpy
  # ...but we can reuse the numpy egg that has been built by buildout.
  ${:location}/bin/easy_install $NUMPY_EGG
  # look for numpy in buildout eggs, not in the virtualenv
  export PYTHONPATH=$NUMPY_EGG
  cd ${scipy-repository.git:location}
  python setupegg.py bdist_egg
  cd ${scikit-learn-repository.git:location}
  python setup.py bdist_egg
update_cmd = ${:install_cmd}


[numpy-prerequired-egg]
recipe = zc.recipe.egg
# this must be installed before building scipy and scikit-learn
eggs =
  ${lxml-python:egg}
  virtualenv
  cython
  numpy


[numpy-dependent-eggs]
dependencies = ${numpy-build-venv:recipe}
recipe = zc.recipe.egg
find-links =
    ${scipy-repository.git:location}/dist
    ${scikit-learn-repository.git:location}/dist
eggs =
  numpy
  scipy
  scikit-learn
  simpy
interpreter = python-numpy


[versions]
numpy = 1.8.1
scipy = 0.13.3
scikit-learn = 0.15.1

