[buildout]
parts =
  libatlas


[skip-throttle-check.patch]
recipe = hexagonit.recipe.download
md5sum = 17c8471d67c99fac80ace05273ce0817
url = ${:_profile_base_location_}/${:filename}
filename = ${:_buildout_section_name_}
download-only = true


[libatlas]
recipe = cp.recipe.cmd
location = ${buildout:parts-directory}/${:_buildout_section_name_}
version = 3.10.1
lapack_version = 3.5.0
filename = atlas${:version}.tar.bz2
install_cmd =
  set -e
  mkdir -p ${:location}__compile__
  cd ${:location}__compile__
  export SRCdir=`pwd`/ATLAS
  export BLDdir=`pwd`/build
  wget -nc http://downloads.sourceforge.net/project/math-atlas/Stable/${:version}/${:filename}
  wget -nc http://www.netlib.org/lapack/lapack-${:lapack_version}.tgz
  echo "78753e869231cc1417a92eebaa076718  ${:filename}" | md5sum --check --strict --quiet -
  tar xfj atlas${:version}.tar.bz2
  cd $SRCdir
  # http://stackoverflow.com/questions/14592401/atlas-install-really-need-to-get-past-cpu-throttle-check
  # http://sourceforge.net/p/math-atlas/support-requests/886/
  patch -p1 <${skip-throttle-check.patch:location}/${skip-throttle-check.patch:filename}
  mkdir -p $BLDdir
  cd $BLDdir
  export F77LIB=${gcc-fortran:location}/lib64/libgfortran.so.3
  export LD_PRELOAD=$F77LIB
  $SRCdir/configure -b 64 \
        --prefix=${:location} \
        --with-netlib-lapack-tarfile=${:location}__compile__/lapack-${:lapack_version}.tgz \
        -C acg ${gcc-fortran:location}/bin/gcc \
        -C if ${gcc-fortran:location}/bin/gfortran \
        --shared

  #-Ss f77lib `${gcc-fortran:location}/bin/gfortran --print-file-name=libgfortran.so` \

  make build    # tune & build lib
  make check    # sanity check correct answer
#  make ptcheck  # sanity check parallel
  make time     # check if lib is fast
  make install  # copy libs to install dir 
update_cmd = ${:install_cmd}

