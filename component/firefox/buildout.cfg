[buildout]
extends =
  ../alsa/buildout.cfg
  ../dbus/buildout.cfg
  ../fontconfig/buildout.cfg
  ../gtk-2/buildout.cfg
  ../gtk-3/buildout.cfg
  ../libffi/buildout.cfg
  ../libpng/buildout.cfg
  ../mesa/buildout.cfg
  ../p11-kit/buildout.cfg
  ../pcre/buildout.cfg
  ../xorg/buildout.cfg
  ../xz-utils/buildout.cfg

parts =
  firefox
  geckodriver

# XXX : Firefox binary tries to find libgnomeui-2.so.0 and it will
# fail to run if exists.

[firefox]
recipe = slapos.recipe.build
location = ${buildout:bin-directory}/${:_buildout_section_name_}
part = ${firefox-52:location}
script =
  firefox = self.options['part']
  part = self.buildout[os.path.basename(firefox)]
  with open(%(location)r, 'w') as f:
    f.write("""#!/bin/sh -e
  cd %%s
  export LD_LIBRARY_PATH=$PWD:%%s
  export PATH=%%s:$PATH
  exec ./firefox "$@" 2>/dev/null
  """ %% (
    firefox,
    ':'.join(part['library'].split()),
    ':'.join(part['path'].split()),
  ))
    os.fchmod(f.fileno(), 0o755)

[firefox-52]
recipe = slapos.recipe.build
slapos_promise =
  file:firefox

version = 52.5.3esr

x86 = http://download-installer.cdn.mozilla.net/pub/firefox/releases/${:version}/linux-i686/en-US/firefox-${:version}.tar.bz2
  94d55883cc16715305f0f18a6f8e9e6b
x86-64 = http://download-installer.cdn.mozilla.net/pub/firefox/releases/${:version}/linux-x86_64/en-US/firefox-${:version}.tar.bz2
  9ead37d114cfdccb90376a35e7ba691e

fonts =
  ${liberation-fonts:location}
  ${ipaex-fonts:location}
library =
  ${alsa:location}/lib
  ${atk:location}/lib
  ${at-spi2-atk:location}/lib
  ${at-spi2-core:location}/lib
  ${bzip2:location}/lib
  ${cairo:location}/lib
  ${dbus:location}/lib
  ${dbus-glib:location}/lib
  ${fontconfig:location}/lib
  ${freetype:location}/lib
  ${gdk-pixbuf:location}/lib
  ${gettext:location}/lib
  ${glib:location}/lib
  ${gtk-3:location}/lib
  ${harfbuzz:location}/lib
  ${libepoxy:location}/lib
  ${libffi:location}/lib
  ${libICE:location}/lib
  ${libpng:location}/lib
  ${libSM:location}/lib
  ${libtool:location}/lib
  ${libuuid:location}/lib
  ${libX11:location}/lib
  ${libXau:location}/lib
  ${libxcb:location}/lib
  ${libXcomposite:location}/lib
  ${libXcursor:location}/lib
  ${libXext:location}/lib
  ${libXi:location}/lib
  ${libxml2:location}/lib
  ${libXrender:location}/lib
  ${libXt:location}/lib
  ${mesa:location}/lib
  ${pango:location}/lib
  ${pcre:location}/lib
  ${pixman:location}/lib
  ${xdamage:location}/lib
  ${xfixes:location}/lib
  ${xz-utils:location}/lib
  ${zlib:location}/lib
path =
  ${fontconfig:location}/bin

script =
  url, md5sum = self.options[guessPlatform()].split()
  extract_dir = self.extract(self.download(url, md5sum))
  self.copyTree(guessworkdir(extract_dir), %(location)r)

[geckodriver]
recipe = slapos.recipe.build
location = ${buildout:bin-directory}/${:_buildout_section_name_}

version = 0.17.0

x86 = https://github.com/mozilla/geckodriver/releases/download/v${:version}/geckodriver-v${:version}-linux32.tar.gz
  79b1a158f96d29942a111c0905f1c807
x86-64 = https://github.com/mozilla/geckodriver/releases/download/v${:version}/geckodriver-v${:version}-linux64.tar.gz
  be18faeea6e7db9db6990d8667e2298f

script =
  url, md5sum = self.options[guessPlatform()].split()
  extract_dir = self.extract(self.download(url, md5sum))
  shutil.copy(extract_dir + '/geckodriver', %(location)r)
